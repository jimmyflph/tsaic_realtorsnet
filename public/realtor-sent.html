<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sent Messages - AI Realty</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #fff; color: #222; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .page-header-left h1 { margin: 0; font-size: 2rem; font-weight: 700; }
    .page-header-right { display: flex; gap: 8px; align-items: center; }
    .btn-action { background: transparent; border: none; color: #222; font-weight: 600; padding: 4px 8px; cursor: pointer; text-decoration: none; }
    .btn-action:hover { color: #667eea; text-decoration: underline; }
    .btn-action.text-danger { color: #dc3545; }
    .btn-action.text-danger:hover { color: #c82333; }
    .pagination-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; }
    .pagination-container nav { display: flex; gap: 5px; }
    .pagination .page-link { border: none; background: none; color: #667eea; font-weight: 600; padding: 4px 8px; text-decoration: none; cursor: pointer; }
    .pagination .page-link:hover { color: #764ba2; text-decoration: underline; }
    .pagination .page-item.active .page-link { color: #667eea; font-weight: 700; text-decoration: underline; }
    .pagination .page-item.disabled .page-link { color: #ccc; cursor: not-allowed; }
    .record-info { text-align: center; color: #667; font-size: 0.9rem; margin-top: 20px; }
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg" style="color:white!important;background: linear-gradient(135deg, #7492eb 0%, #aa5ff5 100%) !important;">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/" style="color:white!important;border-color:white!important;">AI Realty</a>
    <div class="ms-auto d-flex align-items-center" style="gap:8px;">
      <a href="/realtor-messages" class="btn btn-sm" style="color:white!important;">Messages</a>
      <a href="/search-property" class="btn btn-sm" style="color:white!important;">Search</a>
      <button id="logoutBtn" class="btn btn-sm" style="color:white!important;">Logout</button>
    </div>
  </div>
</nav>

<section class="py-5">
  <div class="container">
    <div class="page-header">
      <div class="page-header-left">
        <h1>Sent</h1>
      </div>
      <div class="page-header-right">
        <a href="/realtor-messages" class="btn btn-dark btn-sm">Inbox</a>
        <a href="/send-message" class="btn btn-dark btn-sm">+ Send</a>
        <a href="/realtor-home" class="btn btn-outline-dark btn-sm">Back</a>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th id="contactHeader">Receiver</th>
                <th>Title</th>
                <th>Message</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="messagesTable">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
          <nav aria-label="Page navigation">
            <ul class="pagination mb-0" id="paginationControls"></ul>
          </nav>
        </div>

        <!-- Record info -->
        <div class="record-info">
          Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> messages
        </div>
      </div>
    </div>
  </div>
</section>

<footer>
  <div class="container text-center">
    <small>© 2026 AI Realty — Intelligent Real Estate</small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/app.js"></script>
<script>
  const DEFAULT_MAX_ITEMS = 10;

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const page = Math.max(1, parseInt(params.get('page')) || 1);
    const maxItems = Math.max(1, parseInt(params.get('max-items')) || DEFAULT_MAX_ITEMS);
    return { page, maxItems };
  }

  function updateUrlParams(page, maxItems) {
    const params = new URLSearchParams();
    params.set('page', page);
    params.set('max-items', maxItems);
    window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
  }

  let paginationData = { totalPages: 1, totalRecords: 0 };

  async function loadMessages(page = 1) {
    const endpoint = '/api/my-sent-messages';
    const { maxItems } = getUrlParams();
    const messagesTable = document.getElementById('messagesTable');
    const contactHeader = document.getElementById('contactHeader');

    try {
      messagesTable.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

      const response = await fetch(`${endpoint}?page=${page}&maxItems=${maxItems}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (!response.ok) throw new Error('Failed to load messages');

      const data = await response.json();
      
      // Handle both old format (direct array) and new format (object with messages/pagination)
      const messages = Array.isArray(data) ? data : (data.messages || []);
      paginationData = data.pagination || { page, maxItems, totalRecords: messages.length, totalPages: 1 };

      // Always show "Receiver" for sent messages
      contactHeader.textContent = 'Receiver';

      // Render message rows
      if (messages.length === 0) {
        messagesTable.innerHTML = '<tr><td colspan="5" class="text-center">No messages</td></tr>';
      } else {
        messagesTable.innerHTML = messages.map(msg => {
          const contactName = msg.receiver_fullname;
          const date = new Date(msg.created_at).toLocaleDateString();
          const contentPreview = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
          return `
            <tr>
              <td>${escapeHtml(contactName)}</td>
              <td>${escapeHtml(msg.title)}</td>
              <td>${escapeHtml(contentPreview)}</td>
              <td>${date}</td>
              <td>
                <button class="btn-action" onclick="viewMessageModal(${msg.message_id})">View</button>
                <button class="btn-action text-danger" onclick="deleteMessage(${msg.message_id})">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Render pagination controls
      renderPaginationControls(page, maxItems, paginationData.totalPages);
      updateRecordInfo(page, maxItems, paginationData.totalRecords);

      updateUrlParams(page, maxItems);
    } catch (error) {
      console.error('Error loading messages:', error);
      messagesTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading messages</td></tr>';
    }
  }

  function viewMessageModal(messageId) {
    // Find the message in the current loaded data
    const endpoint = '/api/my-sent-messages';
    const { page, maxItems } = getUrlParams();
    
    fetch(`${endpoint}?page=${page}&maxItems=${maxItems}`, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    })
    .then(res => res.json())
    .then(data => {
      const messages = Array.isArray(data) ? data : (data.messages || []);
      const message = messages.find(m => m.message_id === messageId);
      
      if (message) {
        // Use the global viewMessage function from app.js to display modal with sender info
        const receiverName = message.receiver_fullname || '';
        const receiverUsername = message.receiver_username || message.receiver_email || '';
        window.viewMessage(escapeHtml(message.title), escapeHtml(message.content), escapeHtml(receiverName), escapeHtml(receiverUsername));
      } else {
        alert('Message not found');
      }
    })
    .catch(err => {
      console.error('Error fetching message:', err);
      alert('Error loading message');
    });
  }

  async function deleteMessage(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) return;

    try {
      const response = await fetch(`/api/messages/${messageId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });

      if (response.ok) {
        loadMessages();
      } else {
        alert('Failed to delete message');
      }
    } catch (error) {
      console.error('Error deleting message:', error);
      alert('Error deleting message');
    }
  }

  function updateRecordInfo(page, maxItems, totalRecords) {
    const startRecord = totalRecords === 0 ? 0 : (page - 1) * maxItems + 1;
    const endRecord = Math.min(page * maxItems, totalRecords);
    
    document.getElementById('startRecord').textContent = startRecord;
    document.getElementById('endRecord').textContent = endRecord;
    document.getElementById('totalRecords').textContent = totalRecords;
  }

  function renderPaginationControls(currentPage, maxItems, totalPages) {
    const paginationHTML = [];

    // Previous button
    paginationHTML.push(`
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="?page=${Math.max(1, currentPage - 1)}&max-items=${maxItems}">Previous</a>
      </li>
    `);

    // Page numbers with smart display
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (startPage > 1) {
      paginationHTML.push(`
        <li class="page-item">
          <a class="page-link" href="?page=1&max-items=${maxItems}">1</a>
        </li>
      `);
      if (startPage > 2) {
        paginationHTML.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHTML.push(`
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="?page=${i}&max-items=${maxItems}">${i}</a>
        </li>
      `);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
      paginationHTML.push(`
        <li class="page-item">
          <a class="page-link" href="?page=${totalPages}&max-items=${maxItems}">${totalPages}</a>
        </li>
      `);
    }

    // Next button
    paginationHTML.push(`
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="?page=${Math.min(totalPages, currentPage + 1)}&max-items=${maxItems}">Next</a>
      </li>
    `);

    document.getElementById('paginationControls').innerHTML = paginationHTML.join('');
  }

  // Load sent messages on page load with query params
  window.addEventListener('popstate', () => {
    const { page } = getUrlParams();
    loadMessages(page);
  });

  const { page } = getUrlParams();
  loadMessages(page);
</script>
</body>
</html>
