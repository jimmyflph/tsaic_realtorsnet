<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtor Reviews - AI Realty</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #ffffff;
      color: #222;
    }

    /* HERO */
    .hero {
      background: linear-gradient(to right, rgba(249, 250, 251, 0.9), rgba(255, 255, 255, 0.9)), url('/images/map.jpg') center/cover no-repeat;
      padding: 60px 0;
    }

    .hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .reviews-section {
      padding: 60px 0;
    }

    .review-item {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      padding: 25px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .review-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .review-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .review-info {
      flex: 1;
    }

    .review-name {
      font-size: 1rem;
      font-weight: 700;
      color: #222;
      margin-bottom: 3px;
    }

    .review-meta {
      font-size: 0.85rem;
      color: #999;
    }

    .review-rating {
      font-size: 0.95rem;
      color: #667eea;
      font-weight: 600;
    }

    .review-text {
      font-size: 0.95rem;
      color: #555;
      line-height: 1.6;
      margin-top: 12px;
    }

    .no-reviews {
      text-align: center;
      padding: 60px 20px;
      background: #f9fafb;
      border-radius: 12px;
    }

    .no-reviews p {
      color: #999;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }

    .back-btn {
      display: inline-block;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      color: white;
    }

    .pagination-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 30px; }
    .pagination-container nav { display: flex; gap: 5px; }
    .pagination .page-link { border: none; background: none; color: #333; font-weight: 600; padding: 4px 8px; text-decoration: none; cursor: pointer; }
    .pagination .page-link:hover { color: #764ba2; text-decoration: underline; }
    .pagination .page-item.active .page-link { color: #667eea; font-weight: 700; text-decoration: underline; }
    .pagination .page-item.disabled .page-link { color: #ccc; cursor: not-allowed; }
    .record-info { text-align: center; color: #667; font-size: 0.9rem; margin-top: 20px; }

    footer {
      background: #f9fafb;
      padding: 40px 0;
      color: #777;
      margin-top: 80px;
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg" style="color:white!important;background: linear-gradient(135deg, #7492eb 0%, #aa5ff5 100%) !important;">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/" style="color:white!important;border-color:white!important;">AI Realty</a>
    <div class="ms-auto d-flex align-items-center" style="gap:8px;">
      <a href="#" id="messagesLink" class="btn btn-sm" style="color:white!important;">Messages</a>
      <a href="#" id="settingsBtn" class="btn btn-sm" style="color:white!important;display:none">Settings</a>
      <a href="/search-property" class="btn btn-sm" style="color:white!important;">Search</a>
      <button id="logoutBtn" class="btn btn-sm" style="color:white!important;">Logout</button>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
      <div>
        <h1 id="pageTitle">Reviews for <span id="realtorName">Realtor</span></h1>
        <p class="text-muted">See what clients say about this real estate professional</p>
      </div>
      <a id="addReviewBtn" class="back-btn" href="#" style="white-space: nowrap;">+ Add Review</a>
    </div>
  </div>
</section>

<!-- REVIEWS SECTION -->
<section class="reviews-section">
  <div class="container">
    <div id="reviewsList"></div>

    <!-- Pagination -->
    <div class="pagination-container" id="paginationSection" style="display: none;">
      <nav aria-label="Page navigation">
        <ul class="pagination mb-0" id="paginationControls"></ul>
      </nav>
    </div>

    <!-- Record info -->
    <div class="record-info" id="recordInfo" style="display: none;">
      Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> reviews
    </div>
  </div>
</section>

<footer>
  <div class="container text-center">
    <small>© 2026 AI Realty — Intelligent Real Estate</small>
  </div>
</footer>

<!-- Add Review Modal -->
<div class="modal fade" id="addReviewModal" tabindex="-1" aria-labelledby="addReviewLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addReviewLabel">Add Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reviewForm">
          <div class="mb-3">
            <label for="ratingInput" class="form-label">Rating (1-5)</label>
            <select id="ratingInput" class="form-control" required>
              <option value="">Select a rating</option>
              <option value="1">⭐ 1 - Poor</option>
              <option value="2">⭐ 2 - Fair</option>
              <option value="3">⭐ 3 - Good</option>
              <option value="4">⭐ 4 - Very Good</option>
              <option value="5">⭐ 5 - Excellent</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="reviewTextarea" class="form-label">Review</label>
            <textarea id="reviewTextarea" class="form-control" rows="4" placeholder="Share your experience..."></textarea>
          </div>
          <div id="reviewFormError" class="alert alert-danger" style="display: none;"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitReviewBtn">Submit Review</button>
      </div>
    </div>
  </div>
</div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const DEFAULT_MAX_ITEMS = 10;

  if (!window.REALTOR_IMAGES) {
    window.REALTOR_IMAGES = [
      'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=400&fit=crop',
      'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=400&fit=crop',
      'https://images.unsplash.com/photo-1545996124-1f2a0d4f2f4a?w=400&h=400&fit=crop',
      'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?w=400&h=400&fit=crop',
      'https://images.unsplash.com/photo-1552053831-71594a27632d?w=400&h=400&fit=crop'
    ];
  }

  function getIdFromPath() {
    const parts = window.location.pathname.split('/');
    return parts.length > 2 ? parts[2] : null;
  }

  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const page = Math.max(1, parseInt(params.get('page')) || 1);
    const maxItems = Math.max(1, parseInt(params.get('max-items')) || DEFAULT_MAX_ITEMS);
    return { page, maxItems };
  }

  function updateUrlParams(page, maxItems) {
    const params = new URLSearchParams();
    params.set('page', page);
    params.set('max-items', maxItems);
    window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  let paginationData = { totalPages: 1, totalRecords: 0 };

  async function loadRealtorReviews(realtorId, page = 1) {
    const reviewsList = document.getElementById('reviewsList');
    const { maxItems } = getUrlParams();
    
    try {
      // Load realtor name
      const realtorResp = await fetch(`/api/realtors/${realtorId}`);
      if (realtorResp.ok) {
        const realtor = await realtorResp.json();
        document.getElementById('realtorName').textContent = realtor.fullname || realtor.username || 'Realtor';
        document.title = `${realtor.fullname || 'Realtor'} Reviews - AI Realty`;
      }

      // Load reviews with pagination
      const resp = await fetch(`/api/realtors/${realtorId}/reviews?page=${page}&maxItems=${maxItems}`);
      if (!resp.ok) {
        throw new Error('Failed to load reviews');
      }

      const data = await resp.json();
      const reviews = data.reviews || [];
      paginationData = data.pagination || { page, maxItems, totalRecords: reviews.length, totalPages: 1 };

      if (!reviews || reviews.length === 0) {
        reviewsList.innerHTML = `
          <div class="no-reviews">
            <p>No reviews yet for this realtor</p>
            <a href="/realtor-view/${realtorId}" class="back-btn">Back to Realtor Profile</a>
          </div>
        `;
        document.getElementById('paginationSection').style.display = 'none';
        document.getElementById('recordInfo').style.display = 'none';
        return;
      }

      reviewsList.innerHTML = reviews.map((review, i) => {
        const stars = '⭐'.repeat(review.rating || 0);
        const reviewImg = review.buyer_image || window.REALTOR_IMAGES[i % window.REALTOR_IMAGES.length];
        const createdAt = new Date(review.created_at).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });

        return `
          <div class="review-item">
            <div class="review-header">
              <img src="${reviewImg}" alt="reviewer" class="review-avatar">
              <div class="review-info">
                <div class="review-name">${escapeHtml(review.buyer_name || 'Anonymous')}</div>
                <div class="review-meta">
                  <div class="review-rating">${stars} ${review.rating}/5</div>
                  <div>${createdAt}</div>
                </div>
              </div>
            </div>
            <div class="review-text">${escapeHtml(review.review || 'No text provided')}</div>
          </div>
        `;
      }).join('');

      // Render pagination controls
      renderPaginationControls(page, maxItems, paginationData.totalPages);
      updateRecordInfo(page, maxItems, paginationData.totalRecords);
      updateUrlParams(page, maxItems);

    } catch (err) {
      console.error('Error loading reviews:', err);
      reviewsList.innerHTML = `
        <div class="no-reviews">
          <p>Error loading reviews. Please try again later.</p>
          <a href="/" class="back-btn">Back to Home</a>
        </div>
      `;
      document.getElementById('paginationSection').style.display = 'none';
      document.getElementById('recordInfo').style.display = 'none';
    }
  }

  function updateRecordInfo(page, maxItems, totalRecords) {
    const startRecord = totalRecords === 0 ? 0 : (page - 1) * maxItems + 1;
    const endRecord = Math.min(page * maxItems, totalRecords);
    
    document.getElementById('startRecord').textContent = startRecord;
    document.getElementById('endRecord').textContent = endRecord;
    document.getElementById('totalRecords').textContent = totalRecords;
    
    // Show pagination info only if there are multiple pages
    if (totalRecords > maxItems) {
      document.getElementById('recordInfo').style.display = 'block';
    } else {
      document.getElementById('recordInfo').style.display = 'none';
    }
  }

  function renderPaginationControls(currentPage, maxItems, totalPages) {
    const paginationControls = document.getElementById('paginationControls');
    const paginationSection = document.getElementById('paginationSection');
    
    if (totalPages <= 1) {
      paginationSection.style.display = 'none';
      return;
    }

    paginationSection.style.display = 'flex';
    const paginationHTML = [];

    // Previous button
    paginationHTML.push(`
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="?page=${Math.max(1, currentPage - 1)}&max-items=${maxItems}">Previous</a>
      </li>
    `);

    // Page numbers with smart display
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (startPage > 1) {
      paginationHTML.push(`
        <li class="page-item">
          <a class="page-link" href="?page=1&max-items=${maxItems}">1</a>
        </li>
      `);
      if (startPage > 2) {
        paginationHTML.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationHTML.push(`
        <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="?page=${i}&max-items=${maxItems}">${i}</a>
        </li>
      `);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
      }
      paginationHTML.push(`
        <li class="page-item">
          <a class="page-link" href="?page=${totalPages}&max-items=${maxItems}">${totalPages}</a>
        </li>
      `);
    }

    // Next button
    paginationHTML.push(`
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="?page=${Math.min(totalPages, currentPage + 1)}&max-items=${maxItems}">Next</a>
      </li>
    `);

    paginationControls.innerHTML = paginationHTML.join('');
  }

  // Initialize
  window.addEventListener('popstate', () => {
    const realtorId = getIdFromPath();
    const { page } = getUrlParams();
    if (realtorId) {
      loadRealtorReviews(realtorId, page);
    }
  });

  const realtorId = getIdFromPath();
  if (realtorId) {
    const { page } = getUrlParams();
    loadRealtorReviews(realtorId, page);
    
    // Setup Add Review button
    const addReviewBtn = document.getElementById('addReviewBtn');
    const addReviewModal = new bootstrap.Modal(document.getElementById('addReviewModal'), {});
    if (addReviewBtn) {
      addReviewBtn.addEventListener('click', (e) => {
        e.preventDefault();
        addReviewModal.show();
      });
    }
    
    // Setup Review Form Submission
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewForm = document.getElementById('reviewForm');
    const reviewFormError = document.getElementById('reviewFormError');
    
    if (submitReviewBtn) {
      submitReviewBtn.addEventListener('click', async () => {
        const rating = document.getElementById('ratingInput').value;
        const reviewText = document.getElementById('reviewTextarea').value;
        
        if (!rating) {
          reviewFormError.textContent = 'Please select a rating';
          reviewFormError.style.display = 'block';
          return;
        }
        
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
          reviewFormError.textContent = 'Please log in to add a review';
          reviewFormError.style.display = 'block';
          return;
        }
        
        submitReviewBtn.disabled = true;
        submitReviewBtn.textContent = 'Submitting...';
        reviewFormError.style.display = 'none';
        
        try {
          const response = await fetch(`/api/realtors/${realtorId}/reviews`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              rating: parseInt(rating),
              review: reviewText || ''
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to submit review');
          }
          
          // Close modal and reload reviews
          addReviewModal.hide();
          reviewForm.reset();
          const { page } = getUrlParams();
          loadRealtorReviews(realtorId, page);
          
        } catch (err) {
          console.error('Error submitting review:', err);
          reviewFormError.textContent = err.message;
          reviewFormError.style.display = 'block';
        } finally {
          submitReviewBtn.disabled = false;
          submitReviewBtn.textContent = 'Submit Review';
        }
      });
    }
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = '/login.html';
  });
  
  // Role-aware messages/settings links
  (function(){
    const token = localStorage.getItem('token');
    const messagesLink = document.getElementById('messagesLink');
    const settingsBtn = document.getElementById('settingsBtn');

    function decodePayload(tok){
      try{
        const parts = tok.split('.'); if(parts.length<2) return null;
        const payload = parts[1].replace(/-/g,'+').replace(/_/g,'/');
        const json = decodeURIComponent(atob(payload).split('').map(function(c){ return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2); }).join(''));
        return JSON.parse(json);
      }catch(e){return null}
    }

    if(messagesLink){
      if(token){
        const payload = decodePayload(token);
        const role = payload && payload.role ? payload.role : '';
        messagesLink.href = role === 'realtor' ? '/realtor-messages' : '/client-messages';
        if(settingsBtn){ settingsBtn.style.display = ''; settingsBtn.href = role === 'realtor' ? '/realtor-settings' : '/settings'; }
      } else {
        messagesLink.href = '/login.html';
        if(settingsBtn) settingsBtn.style.display = 'none';
      }
    }
  })();
</script>

</body>
</html>
